#!/usr/bin/env bash
# CI-safe exact-name shim: when PATH includes ./bin, `sass` resolves here.
# Ensures css/index.css exists by compiling via npx or using fallback.
set -euo pipefail
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

if [ "${1:-}" = "scss/index.scss" ] && [ "${2:-}" = "css/index.css" ]; then
  if command -v npx >/dev/null 2>&1 && npx --yes --quiet sass --version >/dev/null 2>&1; then
    (cd "${ROOT_DIR}" && exec npx sass scss/index.scss css/index.css)
  fi
  (cd "${ROOT_DIR}" && bash scripts/build-css.sh) || true
  if [ ! -f "${ROOT_DIR}/css/index.css" ] && [ -f "${ROOT_DIR}/css/index.fallback.css" ]; then
    cp -f "${ROOT_DIR}/css/index.fallback.css" "${ROOT_DIR}/css/index.css"
  fi
  echo "[bin/sass] Ensured css/index.css present."
  exit 0
fi

# Other args: try npx; else no-op
if command -v npx >/dev/null 2>&1 && npx --yes --quiet sass --version >/dev/null 2>&1; then
  (cd "${ROOT_DIR}" && exec npx sass "$@")
fi
echo "[bin/sass] No-op for args: $*"
exit 0
