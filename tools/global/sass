#!/usr/bin/env bash
# Global-in-repo sass shim: intended for CI systems with unusual working directories.
# Always ensures css/index.css is present by compiling (npx) or copying fallback.
set -euo pipefail
# Resolve repo root from this script's location
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "${SCRIPT_DIR}/../.." && pwd)"

if [ "${1:-}" = "scss/index.scss" ] && [ "${2:-}" = "css/index.css" ]; then
  if command -v npx >/dev/null 2>&1 && npx --yes --quiet sass --version >/dev/null 2>&1; then
    (cd "${ROOT_DIR}" && exec npx sass "$@")
  fi
  (cd "${ROOT_DIR}" && bash scripts/build-css.sh) || true
  if [ ! -f "${ROOT_DIR}/css/index.css" ] && [ -f "${ROOT_DIR}/css/index.fallback.css" ]; then
    cp -f "${ROOT_DIR}/css/index.fallback.css" "${ROOT_DIR}/css/index.css"
  fi
  echo "[tools/global/sass] Ensured css/index.css present."
  exit 0
fi

# Other args: try npx sass from repo root; else no-op
if command -v npx >/dev/null 2>&1 && npx --yes --quiet sass --version >/dev/null 2>&1; then
  (cd "${ROOT_DIR}" && exec npx sass "$@")
fi

echo "[tools/global/sass] No-op for args: $*"
exit 0
